<!DOCTYPE html>
<html>

<head>
	<title>Referencio Markdown Playground</title>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			position: relative;
		}

		.content {
			position: relative;
			margin-top: 30px;
			padding: 0px;
			height: 100%;
		}

		#output {
			padding: 2em;
		}

		.box {
			display: flex;
			align-items: center;
			height: 100%;
		}

		.box>div {
			flex: 1;
			height: 100%;
		}

		.header {
			position: fixed;
			top: 0px;
			left: 0px;
			right: 0px;
			height: 30px;
			border-bottom: solid black 2px;
			margin: 0px;
		}
	</style>

	<link rel="stylesheet" href="css/images.css">
	<link rel="stylesheet" href="css/core.css">
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/default.css" id="style">
</head>

<body>
	<div class="header">
		This is the header!
	</div>
	<div class="content">
		<div class="box">
			<div class="row content" id="container"></div>
			<div class="row content" id="output">
				This is the output!
			</div>
		</div>
	</div>

	<script src="js/jquery-3.3.1.min.js"></script>
	<script>var require = {
			paths: {
				'vs': 'js/vs',
				'showdown': 'js/showdown.min.js'
			}
		};
	</script>
	<script src="bin/tables.browser.js"></script>
	<script src="bin/factoriomd.browser.js"></script>
	<script src="bin/objectmodel.browser.js"></script>

	<script src="js/vs/loader.js"></script>

	<script>
		$(document).ready(function () {
			require(['vs/editor/editor.main', 'showdown'], function (_monaco, showdown) {
				let wip = window.localStorage.getItem("wip-md");
				if (!wip) {
                    wip = `Hello, world!
                    { electronic-circuit x 100 }
                    {electronic-circuit}
                    `;
				}
				var editor = monaco.editor.create(document.getElementById("container"), {
					value: wip,
					language: "markdown"
				});
				monaco.editor.setTheme("vs-dark");
				editor.updateOptions({
					codeLens: false,
					minimap: { enabled: false }
				});

				const files = [
					"/bin/object-model/dataset.d.ts",
					"/bin/object-model/item.d.ts",
					"/bin/object-model/recipe.d.ts",
					"/bin/object-model/entity.d.ts",
					"/bin/object-model/types.d.ts",
					"/bin/object-model/physics.d.ts",
					"/bin/tables/tables.d.ts"
				];
                for (const f of files) {
					$.ajax({
						url: f,
						type: "GET",
						success: content => {
							const fileName = f.substr(f.lastIndexOf('/') + 1);
							monaco.languages.typescript.typescriptDefaults.addExtraLib(content + '\r\nexport as namespace ' + fileName.substr(0, fileName.length - 5), f);
						}
					})
				}

				let dataset;

				$.ajax({
					url: '/data/current.json',
					type: "GET",
					success: json => {
						dataset = objectmodel.DataSet.fromJson(json);
						window.setTimeout(rerender, 10);
					}
				});

				window.onresize = function () {
					if (editor) {
						editor.layout();
					}
				};

				function rerender() {
					if (dataset === undefined) return;

					const output = document.getElementById('output');
					while (output.firstChild) {
						output.removeChild(output.firstChild);
					}

					const inputText = editor.getValue();
					
					window.recipes = dataset.recipes;
					window.items = dataset.items;
					window.entities = dataset.entities;
					window.om = dataset;
					const conv = new showdown.Converter({
						tables: true
					});
					conv.useExtension(factoriomd.extensions);

					output.innerHTML = conv.makeHtml(inputText);
				}

				onDidChangeModelContentDebounced(editor, rerender);
				function onDidChangeModelContentDebounced(editor, callback) {
					var timer = -1;
					var runner = function () {
						timer = -1;
						callback();
					}
					return editor.onDidChangeModelContent(function (e) {
						window.localStorage.setItem("wip-md", editor.getValue());
						if (timer !== -1) {
							clearTimeout(timer);
						}
						timer = setTimeout(runner, 300);
					});
				}

				window.setTimeout(rerender, 300);
			});
		});
	</script>


</body>

</html>