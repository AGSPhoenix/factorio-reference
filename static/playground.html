<!DOCTYPE html>
<html>

<head>
	<title>Referencio Table Editor</title>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			position: relative;
		}

		.content {
			position: relative;
			margin-top: 30px;
			padding: 0px;
			height: 100%;
		}

		#output {
			padding: 2em;
		}

		.box {
			display: flex;
			align-items: center;
			height: 100%;
		}

		.box>div {
			flex: 1;
			height: 100%;
		}

		.header {
			position: fixed;
			top: 0px;
			left: 0px;
			right: 0px;
			height: 30px;
			border-bottom: solid black 2px;
			margin: 0px;
		}
	</style>

	<link rel="stylesheet" href="css/images.css">
	<link rel="stylesheet" href="css/core.css">
	<link rel="stylesheet" href="css/default.css" id="style">
</head>

<body>
	<div class="header">
		This is the header!
	</div>
	<div class="content">
		<div class="box">
			<div class="row content" id="container"></div>
			<div class="row content" id="output">
				This is the output!
			</div>
		</div>
	</div>
	<script src="js/jquery-3.3.1.min.js"></script>
	<script>var require = { paths: {
		'vs': 'js/vs',
		'showdown': 'js/showdown.min.js'
	} };</script>

	<script src="js/vs/loader.js"></script>

<script>
		$(document).ready(function () {
			require(['vs/editor/editor.main', 'showdown'], function (_monaco, showdown) {
				var editor = monaco.editor.create(document.getElementById("container"), {
					value: `
basicTable({
	title: "Landfilling a Lake",
	rows: [1, 5, 25, 50, 100, 500, 1000],
	cols: [item("stone"), "Trips", "Time"],
	origin: "Lake Size (Chunks)",
	cell: (r, c, ri, ci) => {
		switch (ci) {
			case 0:
				return large(r * 32 * 32 * 20);
			case 1:
				return ceil(r * 32 * 32 / (80 * 100), false);
			case 2:
				return short_time(r * 32 * 32 / (10 * 25 * 0.8));
		}
	}
});
`,
					language: "typescript"
				});
				monaco.editor.setTheme("vs-dark");
				editor.updateOptions({
					codeLens: false,
					minimap: { enabled: false }
				});
				monaco.languages.typescript.javascriptDefaults.setCompilerOptions({
					lib: ["ES5"],
					target: monaco.languages.typescript.ScriptTarget.ES5,
					allowNonTsExtensions: true
				});

				const files = [
					"/bin/object-model/dataset.d.ts",
					"/bin/object-model/item.d.ts",
					"/bin/object-model/recipe.d.ts",
					"/bin/object-model/entity.d.ts",
					"/bin/object-model/types.d.ts",
					"/bin/object-model/physics.d.ts"
				];

				for (const f of files) {
					$.ajax({
						url: f,
						type: "GET",
						success: content => {
							monaco.languages.typescript.typescriptDefaults.addExtraLib(content, f);
						}
					})
				}
				
				const evalMap = window;
				monaco.languages.typescript.typescriptDefaults.addExtraLib(["declare var om: any"].join('\r\n'), `./builtins.d.ts`);

				window.onresize = function () {
					if (editor) {
						editor.layout();
					}
				};

				function rerender() {
					const output = document.getElementById('output');
					while (output.firstChild) {
						output.removeChild(output.firstChild);
					}
					var c = new showdown.Converter();
					output.innerHTML = c.makeHtml(editor.getValue());
				}

				onDidChangeModelContentDebounced(editor, rerender);
				function onDidChangeModelContentDebounced(editor, callback) {
					var timer = -1;
					var runner = function () {
						timer = -1;
						callback();
					}
					return editor.onDidChangeModelContent(function (e) {
						if (timer !== -1) {
							clearTimeout(timer);
						}
						timer = setTimeout(runner, 300);
					});
				}

				window.setTimeout(rerender, 300);
				// setup.setRenderTarget(document.getElementById('output'));
			});
		});
	</script>


</body>

</html>