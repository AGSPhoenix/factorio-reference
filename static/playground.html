<!DOCTYPE html>
<html>
<head>
	<title>Referencio Table Editor</title>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			position: relative;
		}

		.content {
			position: relative;
			margin-top: 30px;
			padding: 0px;
			height: 100%;
		}

		#output {
			padding: 2em;
		}

		.box {
			display: flex;
			align-items: center;
			height: 100%;
		}

		.box>div {
			flex: 1;
			height: 100%;
		}

		.header {
			position: fixed;
			top: 0px;
			left: 0px;
			right: 0px;
			height: 30px;
			border-bottom: solid black 2px;
			margin: 0px;
		}
	</style>

	<link rel="stylesheet" href="css/images.css">
	<link rel="stylesheet" href="css/core.css">
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/default.css" id="style">
</head>

<body>
	<div class="content">
		<div class="box">
			<div class="row content" id="container"></div>
			<div class="row content" id="output">
				This is the output!
			</div>
		</div>
	</div>

	<script src="js/jquery-3.3.1.min.js"></script>
	<script>var require = {
			paths: {
				'vs': 'js/vs',
				'showdown': 'js/showdown.min.js'
			}
		};
	</script>
	<script src="bundles/tables.js"></script>
	<script src="bundles/object-model.js"></script>
	<script src="bundles/markdown-renderer.js"></script>
	<script src="bundles/showdown-factorio.js"></script>

	<script src="js/vs/loader.js"></script>

	<script>
		$(document).ready(function () {
			require(['vs/editor/editor.main', 'showdown', 'vs/language/typescript/lib/typescriptServices'], function (_monaco, showdown, typescript) {
				let wip = window.localStorage.getItem("wip");
				if (!wip) {
					wip = `tables.basic({
	rows: [1, 5, 25, 50, 100, 500, 1000],
	cols: ["{stone}", "Trips", "Time"],
	origin: "Lake Size (Chunks)",
	cell: (r, c, ri, ci) => {
		switch (ci) {
			case 0:
				return r * 32 * 32 * 20;
			case 1:
				return r * 32 * 32 / (80 * 100);
			case 2:
				return r * 32 * 32 / (10 * 25 * 0.8);
		}
	}
});
`;
				}
				var editor = monaco.editor.create(document.getElementById("container"), {
					value: wip,
					language: "typescript"
				});
				monaco.editor.setTheme("vs-dark");
				editor.updateOptions({
					codeLens: false,
					minimap: { enabled: false }
				});
				monaco.languages.typescript.javascriptDefaults.setCompilerOptions({
					lib: ["ES5"],
					target: monaco.languages.typescript.ScriptTarget.ES5,
					allowNonTsExtensions: true
				});

				const files = [
					"/dts/object-model/index.d.ts",
					"/dts/object-model/dataset.d.ts",
					"/dts/object-model/item.d.ts",
					"/dts/object-model/recipe.d.ts",
					"/dts/object-model/entity.d.ts",
					"/dts/object-model/types.d.ts",
					"/dts/object-model/physics.d.ts",
					"/dts/tables/index.d.ts",
					"/dts/globals.d.ts"
				];

				for (const f of files) {
					$.ajax({
						url: f,
						type: "GET",
						success: content => {
							const fileName = f.substr(f.lastIndexOf('/') + 1);
							monaco.languages.typescript.typescriptDefaults.addExtraLib(content + '\r\nexport as namespace ' + fileName.substr(0, fileName.length - 5), f);
						}
					})
				}

				let dataset;
				$.ajax({
					url: '/data/current.json',
					type: "GET",
					success: json => {
						dataset = objectmodel.DataSet.fromJson(json);
						window.setTimeout(rerender, 10);
					}
				});

				window.onresize = function () {
					if (editor) {
						editor.layout();
					}
				};

				function rerender() {
					if (dataset === undefined) return;

					const output = document.getElementById('output');
					while (output.firstChild) {
						output.removeChild(output.firstChild);
					}

					const inputText = editor.getValue();
					const js = typescript.transpileModule(inputText, { "target": typescript.ScriptTarget.ES5 }).outputText;
					
					window.recipes = dataset.recipes;
					window.items = dataset.items;
					window.entities = dataset.entities;
					window.om = dataset;
					window.tables = tables;
					const outputText = eval.call(window, js);
					const conv = new showdown.Converter({
						tables: true
					});
					conv.useExtension(factoriomd.extensions);

					output.innerHTML = conv.makeHtml(outputText);
				}

				onDidChangeModelContentDebounced(editor, rerender);
				function onDidChangeModelContentDebounced(editor, callback) {
					var timer = -1;
					var runner = function () {
						timer = -1;
						callback();
					}
					return editor.onDidChangeModelContent(function (e) {
						window.localStorage.setItem("wip", editor.getValue());
						if (timer !== -1) {
							clearTimeout(timer);
						}
						timer = setTimeout(runner, 300);
					});
				}

				window.setTimeout(rerender, 300);
			});
		});
	</script>


</body>

</html>